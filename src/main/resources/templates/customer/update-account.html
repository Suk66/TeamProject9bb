<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>회원정보 수정</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        * { font-family: "Merriweather", serif; }
        .mytitle {
            height: 200px; color: white; display: flex;
            align-items: center; justify-content: center;
            background-color: #343a40;
        }
        .mypostingbox {
            width: 500px; margin: 30px auto; padding: 20px;
            box-shadow: 0px 0px 5px 0px gray; border-radius: 5px;
        }
        .mybtn { display: flex; justify-content: center; }
        .mybtn > button { margin: 10px; }
    </style>

</head>
<body>

<div class="mytitle">
    <h1>회원정보 수정</h1>
</div>

<div class="mypostingbox">
    <form id="updateForm">
        <!-- 이메일 (수정 불가) -->
        <div class="form-floating mb-3">
            <input type="text" class="form-control" id="email" readonly>
            <label for="email">이메일</label>
        </div>

        <!-- 이름 -->
        <div class="form-floating mb-3">
            <input type="text" class="form-control" id="name" placeholder="이름">
            <label for="name">이름</label>
        </div>

        <!-- 전화번호 -->
        <div class="form-floating mb-3">
            <input type="text" class="form-control" id="phone" placeholder="휴대폰 번호">
            <label for="phone">휴대폰 번호</label>
        </div>

        <!-- 주소 (일반회원만 표시) -->
        <div class="form-floating mb-3" id="addressField">
            <input type="text" class="form-control" id="addr" placeholder="주소">
            <label for="addr">주소</label>
        </div>

        <!-- 버튼 -->
        <div class="mybtn">
            <button type="submit" class="btn btn-outline-dark">정보 수정</button>
            <button type="reset" class="btn btn-outline-secondary">취소</button>
            <button type="button" class="btn btn-outline-danger" id="deleteAccountBtn">회원 탈퇴</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // ✅ 회원 정보 불러오기 (수정폼이 열릴 때 실행)
        fetch("/account/get-user-info")
            .then(response => response.json())
            .then(data => {
                console.log("📌 [디버깅] 서버에서 받은 회원 정보:", data);
                if (data.success) {
                    document.getElementById("email").value = data.user.email;
                    document.getElementById("name").value = data.user.name;
                    document.getElementById("phone").value = data.user.phone;
                    document.getElementById("addr").value = data.user.addr || "";

                    // ✅ 관리자는 주소 입력 필드 숨기기
                    if (data.user.userType === "admin") {
                        document.getElementById("addressField").style.display = "none";
                    }
                } else {
                    alert("회원 정보를 불러올 수 없습니다.");
                }
            })
            .catch(error => console.error("❌ [오류] 회원 정보 로드 실패:", error));
    });

    // ✅ 회원 정보 수정 기능
    document.getElementById("updateForm").addEventListener("submit", function (event) {
        event.preventDefault();

        const userData = {
            name: document.getElementById("name").value,
            phone: document.getElementById("phone").value,
            addr: document.getElementById("addr") ? document.getElementById("addr").value : ""
        };

        console.log("📌 [디버깅] 서버로 보낼 데이터:", userData);  // ✅ 요청 데이터 확인

        fetch("/account/update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(userData)
        })
            .then(response => response.json())
            .then(data => {
                console.log("📌 [디버깅] 서버 응답:", data);  // ✅ 서버 응답 확인
                alert(data.message);
                if (data.success) {
                    fetchUpdatedUserInfo();
                }
            })
            .catch(error => {
                console.error("❌ [오류] 회원정보 수정 오류:", error);
                alert("오류 발생! 다시 시도하세요.");
            });
    });
    // ✅ 서버에서 최신 회원 정보를 다시 가져와서 화면에 반영하는 함수
    function fetchUpdatedUserInfo() {
        fetch("/account/get-user-info")
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("email").value = data.user.email;
                    document.getElementById("name").value = data.user.name;
                    document.getElementById("phone").value = data.user.phone;
                    if (document.getElementById("addr")) {
                        document.getElementById("addr").value = data.user.addr;
                    }

                    // ✅ 관리자는 주소 입력 필드 숨김
                    if (data.user.userType === "admin") {
                        document.getElementById("addressField").style.display = "none";
                    }
                }
            })
            .catch(error => console.error("❌ [오류] 회원정보 가져오기 실패:", error));
    }
    document.querySelector("button[type='reset']").addEventListener("click", function (event) {
        event.preventDefault();  // 기본 동작(빈칸 초기화) 막기
        fetchUpdatedUserInfo();  // 🔄 기존 회원 정보를 다시 불러와서 복구
    });
    document.getElementById("deleteAccountBtn").addEventListener("click", function () {
        if (!confirm("정말로 회원 탈퇴를 진행하시겠습니까?")) return;

        fetch("/account/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" }
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    window.location.href = "/"; // 탈퇴 성공 시 홈으로 이동
                }
            })
            .catch(error => {
                console.error("회원 삭제 오류:", error);
                alert("회원 삭제 중 오류가 발생했습니다.");
            });
    });
</script>
</body>
</html>