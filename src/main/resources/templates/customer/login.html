<!DOCTYPE html>
<html lang="en" layout:decorate="~{layouts/layout}"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head>
  <title>ë¡œê·¸ì¸ í™”ë©´</title>

<th:block layout:fragment="scripts">
  <script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit" async defer></script>

  <script>
    // reCAPTCHA ë¡œë“œ ì™„ë£Œ í›„ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
    function onRecaptchaLoad() {
      if (typeof grecaptcha === "undefined") {
        console.error("recaptcha ë¡œë“œ ì‹¤íŒ¨");
        setTimeout(onRecaptchaLoad, 3000);  // 3ì´ˆí›„ ë‹¤ì‹œ ë¡œë“œ
        return
      }
      fetch("/api/recaptcha/site-key")
              .then(response => response.text())
              .then(siteKey => {
                if (!siteKey) {
                  console.error("âŒ reCAPTCHA sitekeyë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤!");
                  return;
                }
                console.log("âœ… reCAPTCHA sitekey:", siteKey);

                // reCAPTCHA ë Œë”ë§ (ê°€ì ¸ì˜¨ sitekey ì‚¬ìš©)
                const recaptchaElement = document.getElementById("recaptcha");
                if (recaptchaElement) {

                grecaptcha.render('recaptcha', {
                  'sitekey': siteKey,
                  'theme': 'light'
                });
              } else {
                  console.log("reCAPTCHAë¥¼ ì¶”ê°€í•  ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
              })
              .catch(error => console.error("âš ï¸ reCAPTCHA í‚¤ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
    }
  </script>
</th:block>

</head>

<body>
<main layout:fragment="content">
<div class="mytitle">
  <h1>ë¡œê·¸ì¸</h1>
</div>

<div class="mypostingbox" id="postingbox">
  <form id="loginForm">
    <div class="form-floating mb-3">
      <input type="text" class="form-control" id="email" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
      <label for="email">ì´ë©”ì¼</label>
    </div>

    <div class="form-floating mb-3">
      <input type="password" class="form-control" id="pwd" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
      <label for="pwd">ë¹„ë°€ë²ˆí˜¸</label>
    </div>

    <!-- reCAPTCHA í‘œì‹œ -->
    <div class="g-recaptcha" id="recaptcha"></div>

    <div class="mybtn">
      <button type="submit" class="btn btn-outline-dark" style="margin-right: 30px">ë¡œê·¸ì¸</button>
      <a href="/create" class="btn btn-outline-dark">íšŒì›ê°€ì…</a>
    </div>

    <div class="text-center mt-3">
      <button type="button" class="btn btn-link" onclick="location.href='/find-password'">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</button>
    </div>
  </form>
</div>

<script>
  document.getElementById("loginForm").addEventListener("submit", async function (event) {
    event.preventDefault();

    const email = document.getElementById("email").value.trim();
    const pwd = document.getElementById("pwd").value.trim();
    const recaptchaResponse = grecaptcha.getResponse(); // reCAPTCHA ì‘ë‹µ ê°€ì ¸ì˜¤ê¸°

    if (!email || !pwd) {
      alert("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
      return;
    }
    if (!recaptchaResponse) {
      alert("âš ï¸ reCAPTCHAë¥¼ ì™„ë£Œí•˜ì„¸ìš”!");
      return;
    }

    const loginData = { email, pwd, recaptchaResponse };
    try {
      const response = await fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(loginData)
      });

      const result = await response.json();
      console.log("ğŸ” ì„œë²„ ì‘ë‹µ:", result);

      if (response.status === 200) {
        alert(result.message);
        window.location.href = result.role === "ROLE_ADMIN" ? "/dashboard/admin" : "/dashboard/customer";
      } else {
        alert(result.message || "ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    } catch (error) {
      console.error("âš ï¸ ë¡œê·¸ì¸ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
      alert("âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  });
</script>
</main>

</body>
</html>